<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat con Gemini</title>
<style>
body { font-family: Arial; background: #f0f0f0; padding: 20px; }
#chat { background: white; padding: 10px; border-radius: 10px; height: 400px; overflow-y: auto; }
.msg-user { color: blue; margin: 5px 0; }
.msg-ai { color: green; margin: 5px 0; }
#inputBox { width: 60%; padding: 10px; }
#btn, #btnAuto, #btnManual { padding: 10px 15px; }
#btnAuto, #btnManual { margin-left: 5px; }
.active { background-color: #4CAF50; color: white; }
</style>
</head>
<body>

<h2>üí¨ Chat con Gemini (HTML/JS)</h2>
<div id="chat"></div>

<br>
<input id="inputBox" type="text" placeholder="Escribe aqu√≠...">
<button id="btn">Enviar</button>
<button id="btnAuto">Auto</button>
<button id="btnManual">Manual</button>

<script>
const API_KEY = "AIzaSyAVn2kfSRa9v3LfZIwBTlg6sJkBpJRb7PY";
const MODEL = "gemini-2.0-flash";
const URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;

let history = [];
let autoMode = false;
let ignoreRecognition = false;   // ‚Üê evita que la IA se escuche a s√≠ misma

document.getElementById("btn").onclick = sendMessage;

// ENTER
document.getElementById("inputBox").addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

// BOT√ìN AUTO
const btnAuto = document.getElementById("btnAuto");
btnAuto.addEventListener("click", () => {
    autoMode = !autoMode;
    btnAuto.classList.toggle("active", autoMode);

    if (autoMode) startSpeechRecognition();
    else stopSpeechRecognition();
});

// BOT√ìN MANUAL ‚Üí lee la √∫ltima respuesta
document.getElementById("btnManual").onclick = () => {
    const lastMessage = document.querySelector("#chat > div:last-child.msg-ai");
    if (lastMessage) speak(lastMessage.innerText.replace("Gemini: ", ""));
};

// A√±adir mensaje al chat
function addMessage(text, cls) {
    const chat = document.getElementById("chat");
    const div = document.createElement("div");
    div.className = cls;
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;

    // Si es la IA, hablar (pero activar silencio para que no se escuche a s√≠ misma)
    if (cls === "msg-ai" && autoMode) {
        ignoreRecognition = true;        // ‚Üê activar silencio temporal
        speak(text.replace("Gemini: ", ""));
        setTimeout(() => { ignoreRecognition = false; }, 2000);  // ‚Üê despu√©s de hablar, vuelve a escuchar
    }
}

// Enviar mensaje
async function sendMessage() {
    const userText = document.getElementById("inputBox").value.trim();
    if (userText === "") return;

    addMessage("T√∫: " + userText, "msg-user");
    document.getElementById("inputBox").value = "";

    history.push({ role: "user", parts: [{ text: userText }] });

    try {
        const body = { contents: history };

        const response = await fetch(URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const data = await response.json();
        const output = data.candidates[0].content.parts[0].text;

        addMessage("Gemini: " + output, "msg-ai");

        history.push({ role: "model", parts: [{ text: output }] });

    } catch (error) {
        addMessage("‚ö†Ô∏è Error: " + error, "msg-ai");
    }
}

// Text-to-Speech
function speak(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'es-ES';

    window.speechSynthesis.speak(utterance);
}

// Speech Recognition
let recognition;

function startSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window)) {
        alert("Este navegador no soporta reconocimiento de voz.");
        return;
    }

    recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = function (event) {
        if (ignoreRecognition) return;   // ‚Üê ignorar mientras la IA habla

        const text = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
        console.log("Escuchado:", text);

        if (text === "fin") {            // ‚Üê ACTIVADOR DE ENV√çO
            sendMessage();
        } else {
            document.getElementById("inputBox").value = text;
        }
    };

    recognition.start();
}

function stopSpeechRecognition() {
    if (recognition) recognition.stop();
}
</script>

</body>
</html>
